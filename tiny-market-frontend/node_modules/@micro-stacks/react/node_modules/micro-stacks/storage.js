"use strict"; function _nullishCoalesce(lhs, rhsFn) { if (lhs != null) { return lhs; } else { return rhsFn(); } }'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var crypto = require('micro-stacks/crypto');
var common = require('micro-stacks/common');
var zoneFile = require('micro-stacks/zone-file');

var ae=Object.defineProperty;var ce=(r,e,t)=>e in r?ae(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var z=(r,e,t)=>(ce(r,typeof e!="symbol"?e+"":e,t),t);function de(r){return _nullishCoalesce((r==null?void 0:r.map(e=>({...e,domain:e.path}))), () => (null))}function M(r){let{hubInfo:e,privateKey:t,gaiaHubUrl:o,associationToken:n=null,scopes:s}=r,{challenge_text:i}=e,a=common.bytesToHex(crypto.getPublicKey(t,!0)),u=crypto.getRandomBytes(16).toString();return {gaiaChallenge:i,hubUrl:o,iss:a,salt:u,associationToken:n,scopes:de(s)}}async function ge(r){let e=M(r);return `v1:${await new crypto.TokenSigner("ES256K",r.privateKey).sign(e)}`}function ye(r){let e=M(r);return `v1:${new crypto.TokenSigner("ES256K",r.privateKey).signSync(e)}`}var J={challenge_text:'["gaiahub","0","storage2.blockstack.org","blockstack_storage_please_sign"]',latest_auth_version:"v1",max_file_upload_size_megabytes:20,read_url_prefix:"https://gaia.blockstack.org/hub/"};async function ze(r,e=!1){let{gaiaHubUrl:t,privateKey:o,associationToken:n,scopes:s}=r,i=J;e&&(i=await(await common.fetchPrivate(`${t}/hub_info`)).json());let{read_url_prefix:a,max_file_upload_size_megabytes:u}=i,c=await ge({hubInfo:i,privateKey:o,gaiaHubUrl:t,associationToken:n,scopes:s});return {address:crypto.privateKeyToBase58Address(o),url_prefix:a,token:c,server:t,max_file_upload_size_megabytes:_nullishCoalesce(u, () => (20))}}function je(r){let{gaiaHubUrl:e,privateKey:t,associationToken:o,scopes:n}=r,s=J,{read_url_prefix:i,max_file_upload_size_megabytes:a}=s,u=ye({hubInfo:s,privateKey:t,gaiaHubUrl:e,associationToken:o,scopes:n});return {address:crypto.privateKeyToBase58Address(t),url_prefix:i,token:u,server:e,max_file_upload_size_megabytes:_nullishCoalesce(a, () => (20))}}var w={MISSING_PARAMETER:"missing_parameter",REMOTE_SERVICE_ERROR:"remote_service_error",INVALID_STATE:"invalid_state",NO_SESSION_DATA:"no_session_data",DOES_NOT_EXIST:"does_not_exist",FAILED_DECRYPTION_ERROR:"failed_decryption_error",INVALID_DID_ERROR:"invalid_did_error",NOT_ENOUGH_FUNDS_ERROR:"not_enough_error",INVALID_AMOUNT_ERROR:"invalid_amount_error",LOGIN_FAILED_ERROR:"login_failed",SIGNATURE_VERIFICATION_ERROR:"signature_verification_failure",CONFLICT_ERROR:"conflict_error",NOT_ENOUGH_PROOF_ERROR:"not_enough_proof_error",BAD_PATH_ERROR:"bad_path_error",VALIDATION_ERROR:"validation_error",PAYLOAD_TOO_LARGE_ERROR:"payload_too_large_error",PRECONDITION_FAILED_ERROR:"precondition_failed_error",UNKNOWN:"unknown"};Object.freeze(w);var k=class extends Error{constructor(e){super();let t=e.message,o=`Error Code: ${e.code}`,n=this.stack;if(n)o+=`Stack Trace:
${n}`;else try{throw new Error}catch(s){n=s.stack;}t+=`
If you believe this exception is caused by a bug in blockstack.js,
      please file a bug report: https://github.com/blockstack/blockstack.js/issues

${o}`,this.message=t,this.code=e.code,this.parameter=e.parameter?e.parameter:void 0;}toString(){return `${super.toString()}
    code: ${this.code} param: ${this.parameter?this.parameter:"n/a"}`}};var y=class extends k{constructor(e){let t=`Failed to verify signature: ${e}`;super({code:w.SIGNATURE_VERIFICATION_ERROR,message:t}),this.message=t,this.name="SignatureVerificationError";}};var b=class extends k{constructor(e,t){super(e),t&&(this.hubError={statusCode:t.status,statusText:t.statusText},typeof t.body=="string"?this.hubError.message=t.body:typeof t.body=="object"&&Object.assign(this.hubError,t.body));}},x=class extends b{constructor(e,t){super({message:e,code:w.DOES_NOT_EXIST},t),this.name="DoesNotExist";}},P=class extends b{constructor(e,t){super({message:e,code:w.CONFLICT_ERROR},t),this.name="ConflictError";}},v=class extends b{constructor(e,t){super({message:e,code:w.NOT_ENOUGH_PROOF_ERROR},t),this.name="NotEnoughProofError";}},S=class extends b{constructor(e,t){super({message:e,code:w.BAD_PATH_ERROR},t),this.name="BadPathError";}},C=class extends b{constructor(e,t){super({message:e,code:w.VALIDATION_ERROR},t),this.name="ValidationError";}},E=class extends b{constructor(e,t,o){super({message:e,code:w.PAYLOAD_TOO_LARGE_ERROR},t),this.name="PayloadTooLargeError",this.maxUploadByteSize=o;}},L=class extends b{constructor(e,t){super({message:e,code:w.PRECONDITION_FAILED_ERROR},t),this.name="PreconditionFailedError";}};async function me(r){let e="",t;try{e=await r.text();try{t=JSON.parse(e);}catch (e2){}}catch(i){console.debug(`Error getting bad http response text: ${i}`);}let o=r.status,n=r.statusText;return {status:o,statusText:n,body:t||e}}function G(r){return Number.isFinite(r)?Math.floor(r*1024*1024):0}async function R(r,e,t){if(r.ok)throw new Error("Cannot get a Stacks from a valid response.");let o=await me(r);if(o.status===401)throw new C(e,o);if(o.status===402)throw new v(e,o);if(o.status===403)throw new S(e,o);if(o.status===404)throw new x(e,o);if(o.status===409)throw new P(e,o);if(o.status===412)throw new L(e,o);if(o.status===413){let n=t&&t.max_file_upload_size_megabytes?G(t.max_file_upload_size_megabytes):0;throw new E(e,o,n)}else throw new Error(e)}function Z(r){if(!r||!r.hubError||!r.hubError.statusCode)return !1;let e=r.hubError.statusCode;return e===401||e===409||e>=500&&e<=599}async function A(r){let{filename:e,contents:t,hubConfig:o,contentType:n="application/octet-stream"}=r,s={"Content-Type":n,Authorization:`bearer ${o.token}`},i=await common.fetchPrivate(`${o.server}/store/${o.address}/${e}`,{method:"POST",headers:s,body:t});if(!i.ok)throw await R(i,"Error when uploading to Gaia hub.",o);let a=await i.text();return JSON.parse(a)}function I(r,e){return Promise.resolve(`${e.url_prefix}${e.address}/${r}`)}var h=".sig",U="https://stacks-node-api.stacks.co/v1/names";var $=class{constructor(e,t){this.wasString=typeof e=="string",this.content=$.normalizeContentDataType(e,t),this.contentType=t||this.detectContentType(),this.contentByteLength=this.detectContentLength();}static normalizeContentDataType(e,t){try{if(typeof e=="string"){let o=(t||"").toLowerCase().replace("-","");if(o.includes("charset")&&!o.includes("charset=utf8")&&!o.includes("charset=ascii"))throw new Error(`Unable to determine byte length with charset: ${t}`);return new TextEncoder().encode(e)}else {if(e instanceof Uint8Array)return e;if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);if(typeof Blob<"u"&&e instanceof Blob)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(Array.isArray(e)){if(e.length>0&&(!Number.isInteger(e[0])||e[0]<0||e[0]>255))throw new Error(`Unexpected array values provided as file data: value "${e[0]}" at index 0 is not an octet number. ${this.supportedTypesMsg}`);return new Uint8Array(e)}else {let o=Object.prototype.toString.call(e);throw new Error(`Unexpected type provided as file data: ${o}. ${this.supportedTypesMsg}`)}}}catch(o){throw console.error(o),new Error(`Error processing data: ${o}`)}}detectContentType(){return this.wasString?"text/plain; charset=utf-8":typeof Blob<"u"&&this.content instanceof Blob&&this.content.type?this.content.type:"application/octet-stream"}detectContentLength(){if(ArrayBuffer.isView(this.content)||this.content instanceof Uint8Array)return this.content.byteLength;if(typeof Blob<"u"&&this.content instanceof Blob)return this.content.size;let e=Object.prototype.toString.call(this.content),t=new Error(`Unexpected type "${e}" while detecting content length`);throw console.error(t),t}async loadContent(){try{if(this.content instanceof Uint8Array)return this.content;if(ArrayBuffer.isView(this.content))return new Uint8Array(this.content.buffer,this.content.byteOffset,this.content.byteLength);if(typeof Blob<"u"&&this.content instanceof Blob){let e=new FileReader;return await new Promise((n,s)=>{e.onerror=i=>{s(i);},e.onload=()=>{let i=e.result;n(new Uint8Array(i));},e.readAsArrayBuffer(this.content);})}else {let e=Object.prototype.toString.call(this.content);throw new Error(`Unexpected type ${e}`)}}catch(e){console.error(e);let t=new Error(`Error loading content: ${e}`);throw console.error(t),t}}load(){return this.loadedData===void 0&&(this.loadedData=this.loadContent()),this.loadedData}},O=$;z(O,"supportedTypesMsg","Supported types are: `string` (to be UTF8 encoded), `Uint8Array`, `Blob`, `File`, `ArrayBuffer`, `UInt8Array` or any other typed array buffer. ");async function nt(r,e,t){let{privateKey:o}=t,{encrypt:n,sign:s,gaiaHubConfig:i,cipherTextEncoding:a}=t,{contentType:u=""}=t,c=G(i.max_file_upload_size_megabytes),g=c>0,l=new O(e,u);if(u=l.contentType,!n&&g&&l.contentByteLength>c){let p=`The max file upload size for this hub is ${c} bytes, the given content is ${l.contentByteLength} bytes`,f=new E(p,null,c);throw console.error(f),f}if(n&&g&&a){let p=crypto.eciesGetJsonStringLength({contentLength:l.contentByteLength,wasString:l.wasString,sign:!!s,cipherTextEncoding:a});if(p>c){let f=`The max file upload size for this hub is ${c} bytes, the given content is ${p} bytes after encryption`,d=new E(f,null,c);throw console.error(d),d}}let m;if(!n&&s){let p=await l.load();if(typeof s=="string")o=s;else if(!o)throw Error("Need to pass private key");let f=await crypto.signECDSA({contents:p,privateKey:o});m=async d=>(await Promise.all([A({filename:r,contents:p,hubConfig:d,contentType:u}),A({filename:`${r}${h}`,contents:JSON.stringify(f),hubConfig:d,contentType:"application/json"})]))[0].publicURL;}else {let p;if(!n&&!s)p=l.content;else {let f;if(typeof n=="string")f=n;else if(typeof s=="string")f=common.bytesToHex(crypto.getPublicKey(s,!0));else if(o)f=common.bytesToHex(crypto.getPublicKey(o,!0));else throw new Error("No private key passed");let d=await l.load(),_=await crypto.encryptContent(d,{publicKey:f,wasString:l.wasString,cipherTextEncoding:a,privateKey:o});if(p=JSON.stringify(_),o){let{signature:K,publicKey:T}=await crypto.signECDSA({contents:_,privateKey:o});p=JSON.stringify({signature:K,publicKey:T,cipherText:_});}u="application/json";}m=async f=>(await A({filename:r,contents:p,hubConfig:f,contentType:u})).publicURL;}try{return await m(i)}catch(p){if(Z(p))return console.error(p),console.error("Possible recoverable error during Gaia upload, retrying..."),await m(i);throw p}}function q(r){if(!r.hasOwnProperty("uri")||!Array.isArray(r.uri)||r.uri.length<1)return null;let e=r.uri[0];if(!e.hasOwnProperty("target"))return null;let t=e.target;return t.startsWith("https")||t.startsWith("http")||(t=`https://${t}`),t}function N(r,e){let t;return e.proof&&e.proof.url&&(t=e.proof.url),{"@type":"Account",service:r,identifier:e.username,proofType:"http",proofUrl:t}}function H(r){let e={"@type":"Person"};if(r){r.name&&r.name.formatted&&(e.name=r.name.formatted),r.bio&&(e.description=r.bio),r.location&&r.location.formatted&&(e.address={"@type":"PostalAddress",addressLocality:r.location.formatted});let t=[];r.avatar&&r.avatar.url&&t.push({"@type":"ImageObject",name:"avatar",contentUrl:r.avatar.url}),r.cover&&r.cover.url&&t.push({"@type":"ImageObject",name:"cover",contentUrl:r.cover.url}),t.length&&(e.image=t),r.website&&(e.website=[{"@type":"WebSite",url:r.website}]);let o=[];r.bitcoin&&r.bitcoin.address&&o.push({"@type":"Account",role:"payment",service:"bitcoin",identifier:r.bitcoin.address}),r.twitter&&r.twitter.username&&o.push(N("twitter",r.twitter)),r.facebook&&r.facebook.username&&o.push(N("facebook",r.facebook)),r.github&&r.github.username&&o.push(N("github",r.github)),r.auth&&r.auth.length>0&&r.auth[0]&&r.auth[0].publicKeychain&&o.push({"@type":"Account",role:"key",service:"bip32",identifier:r.auth[0].publicKeychain}),r.pgp&&r.pgp.url&&o.push({"@type":"Account",role:"key",service:"pgp",identifier:r.pgp.fingerprint,contentUrl:r.pgp.url}),e.account=o;}return e}function _e(r,e){let t=crypto.decodeToken(r);if(!t)throw Error("no decoded token");let o=t.payload;if(typeof o=="string")throw new Error("Unexpected token payload type of string");if(o.hasOwnProperty("subject")&&o.subject){if(!o.subject.hasOwnProperty("publicKey"))throw new Error("Token doesn't have a subject public key")}else throw new Error("Token doesn't have a subject");if(o.hasOwnProperty("issuer")&&o.issuer){if(!o.issuer.hasOwnProperty("publicKey"))throw new Error("Token doesn't have an issuer public key")}else throw new Error("Token doesn't have an issuer");if(!o.hasOwnProperty("claim"))throw new Error("Token doesn't have a claim");let n=o.issuer.publicKey,s=crypto.publicKeyToStxAddress(n);if(e!==n){if(e!==s)throw new Error("Token issuer public key does not match the verifying value")}let i=new crypto.TokenVerifier(t.header.alg,n);if(!i)throw new Error("Invalid token verifier");if(!i.verify(r))throw new Error("Token verification failed");return t}function ee(r,e){let t=e?_e(r,e):crypto.decodeToken(r);if(t&&t.hasOwnProperty("payload")){let o=t.payload;if(typeof o=="string")throw new Error("[micro-stacks] extractProfile: Unexpected token payload type of string");if(o.hasOwnProperty("claim"))return o.claim}return {}}async function te(r,e){let t=zoneFile.parseZoneFile(r);if(t.hasOwnProperty("$origin")||(t=null),!(t&&Object.keys(t).length>0))return H(JSON.parse(r));let n=q(t);if(n)try{let i=await(await common.fetchPrivate(n)).json();return ee(i[0].token,e)}catch(s){throw console.error(`[micro-stacks] resolveZoneFileToProfile: error fetching token file ${n}: ${s}`),s}return console.debug("[micro-stacks] Token file url not found. Resolving to blank profile."),{}}async function re(r){let{username:e,zoneFileLookupURL:t=U}=r;if(!e)return Promise.reject();let o=`${t.replace(/\/$/,"")}/${r.username}`,s=await(await common.fetchPrivate(o)).json();if(s.hasOwnProperty("zonefile")&&s.hasOwnProperty("address"))return await te(s.zonefile,r.verify?s.address:void 0);throw new Error("Invalid zonefile lookup response: did not contain `address` or `zonefile` field")}async function oe(r,e,t,o){let n=await re({username:e,zoneFileLookupURL:o}),s;if(!!n)return n.hasOwnProperty("apps")?n.apps.hasOwnProperty(t)&&(s=`${n.apps[t].replace(/\/?(\?|#|$)/,"/$1")}${r}`):n.hasOwnProperty("appsMeta")&&n.appsMeta.hasOwnProperty(t)&&(s=`${n.appsMeta[t].replace(/\/?(\?|#|$)/,"/$1")}${r}`),s}async function ve(r,e){let t;if(e.username?t=await oe(r,e.username,e.app,e.zoneFileLookupURL):t=await I(r,e.gaiaHubConfig),t)return t;throw new Error("Missing readURL")}async function D(r){let{app:e,username:t,zoneFileLookupURL:o,gaiaHubConfig:n}=r,s;t?s=await oe("/",t,e,o):n&&(s=await I("/",n));let i=/([13][a-km-zA-HJ-NP-Z0-9]{26,35})/.exec(s);if(!i)throw new Error("Failed to parse gaia address");return i[i.length-1]}async function F(r){let{path:e,forceText:t,app:o,username:n,zoneFileLookupURL:s,gaiaHubConfig:i}=r,a=await ve(e,{app:o,username:n,zoneFileLookupURL:s,gaiaHubConfig:i}),u=await common.fetchPrivate(a);if(!u.ok)throw await R(u,`getFile ${e} failed.`,null);let c=u.headers.get("Content-Type");if(typeof c=="string"&&(c=c.toLowerCase()),t||c===null||c.startsWith("text")||c.startsWith("application/json"))return u.text();{let g=await u.arrayBuffer();return common.arrayBufferToUint8(g)}}async function ne(r,e){let{app:t,username:o,zoneFileLookupURL:n,gaiaHubConfig:s}=e,i=`${r}${h}`;try{let[a,u,c]=await Promise.all([F({path:r,app:t,username:o,zoneFileLookupURL:n,forceText:!1,gaiaHubConfig:s}),F({path:i,app:t,username:o,zoneFileLookupURL:n,forceText:!0,gaiaHubConfig:s}),D({app:t,username:o,zoneFileLookupURL:n,gaiaHubConfig:s})]);if(!a)return a;if(!c)throw new y(`Failed to get gaia address for verification of: ${r}`);if(!u||typeof u!="string")throw new y(`Failed to obtain signature for file: ${r} -- looked in ${r}${h}`);let g,l;try{let d=JSON.parse(u);g=d.signature,l=d.publicKey;}catch(d){throw d instanceof SyntaxError?new Error(`Failed to parse signature content JSON (path: ${r}${h}) The content may be corrupted.`):d}let m=crypto.publicKeyToBase58Address(l),p=typeof a=="string"?common.utf8ToBytes(a):a,f=crypto.verifyECDSA({signature:g,contents:p,publicKey:l});if(c!==m)throw new y(`Signer pubkey address (${m}) doesn't match gaia address (${c})`);if(f)return a;throw new y(`Contents do not match ECDSA signature: path: ${r}, signature: ${r}${h}`)}catch(a){throw a instanceof x&&a.message.indexOf(i)>=0?new y(`Failed to obtain signature for file: ${r} -- looked in ${r}${h}`):a}}async function ie(r){let{path:e,storedContents:t,app:o,privateKey:n,username:s,zoneFileLookupURL:i,gaiaHubConfig:a}=r,u=n,c=u?crypto.getPublicKey(u,!0):null,g=null;if(s||a?g=await D({app:o,username:s,zoneFileLookupURL:i,gaiaHubConfig:a}):c&&(g=crypto.publicKeyToBase58Address(c)),!g)throw new y(`Failed to get gaia address for verification of: ${e}`);let l;try{l=JSON.parse(t);}catch(T){throw T instanceof SyntaxError?new Error("Failed to parse encrypted, signed content JSON. The content may not be encrypted. If using getFile, try passing { verify: false, decrypt: false }."):T}let m=l.signature,p=l.publicKey,f=l.cipherText,d=crypto.publicKeyToBase58Address(p);if(!p||!f||!m)throw new y(`Failed to get signature verification data from file: ${e}`);if(d!==g)throw new y(`Signer pubkey address (${d}) doesn't match gaia address (${g})`);if(!crypto.verifyECDSA({signature:m,contents:f,publicKey:p}))throw new y(`Contents do not match ECDSA signature in file: ${e}`);if(!n)throw Error("Private key needs to be passed in order to decrypt content");return crypto.decryptContent(f,{privateKey:n})}async function Bt(r,e){let t={decrypt:!0,verify:!1,app:common.getGlobalObject("location",{returnEmptyObject:!0}).origin,zoneFileLookupURL:U,...e};if(t.verify&&!t.decrypt)return ne(r,t);let o=await F({path:r,app:t.app,username:t.username,zoneFileLookupURL:t.zoneFileLookupURL,forceText:!!t.decrypt,gaiaHubConfig:t.gaiaHubConfig});if(o===null)return o;if(typeof o!="string")throw new Error("[micro-stacks/storage] Expected to get back a string for the cipherText");let n=!!t.verify,s=!!t.decrypt,i=typeof t.decrypt=="string"?t.decrypt:t.privateKey;if(o.includes("signature")&&o.includes("publicKey")&&(n=!0),o.includes("cipherText")&&o.includes("ephemeralPK")&&(s=!0),!n&&!s)return o;let a=!o.includes("cipherText");if(s&&a)throw new Error(`[micro-stacks/storage] Expected to get back a string that includes cipherText, is it encrypted? got back: ${JSON.stringify(o)}`);if(!i)throw new Error("[micro-stacks/storage] No private key was passed to getFile, a private key needs to be passed if decrypt is set to true");if(!n)return crypto.decryptContent(o,{privateKey:i});if(s&&n)return ie({path:r,storedContents:o,app:t.app,privateKey:i,username:t.username,zoneFileLookupURL:t.zoneFileLookupURL,gaiaHubConfig:t.gaiaHubConfig});throw new Error("[micro-stacks/storage] Should be unreachable.")}async function B(r,e){let t=await common.fetchPrivate(`${e.server}/delete/${e.address}/${r}`,{method:"DELETE",headers:{Authorization:`bearer ${e.token}`}});if(!t.ok)throw await R(t,"Error deleting file from Gaia hub.",e)}async function Zt(r,e){let{gaiaHubConfig:t,wasSigned:o}=e,n=[B(r,t)];o&&n.push(B(`${r}${h}`,t)),await Promise.all(n);}

exports.deleteFile = Zt;
exports.deleteFromGaiaHub = B;
exports.generateGaiaHubConfig = ze;
exports.generateGaiaHubConfigSync = je;
exports.getFile = Bt;
exports.getFullReadUrl = I;
exports.lookupProfile = re;
exports.makeScopedGaiaAuthToken = ge;
exports.makeScopedGaiaAuthTokenPayload = M;
exports.makeScopedGaiaAuthTokenSync = ye;
exports.putFile = nt;
exports.uploadToGaiaHub = A;
